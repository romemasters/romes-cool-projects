<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Zombie Survival RPG</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --accent: #f38020;
      --accent2: #ffb47e;
      --bg: #191c26;
      --panel: #22243a;
      --txt: #fff;
      --card: #292c3c;
      --health: #e74c3c;
      --energy: #27ae60;
      --xp: #2980b9;
      --modalbg: #22243acc;
      --sidebar-width: 290px;
      --header-height: 64px;
    }
    html, body {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--txt);
      font-family: 'Inter', Arial, sans-serif;
      box-sizing: border-box;
    }
    body {
      min-height: 100vh;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .header {
      height: var(--header-height);
      min-height: var(--header-height);
      background: var(--panel);
      color: var(--accent);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 2em 0 1.7em;
      font-size: 1.2em;
      font-weight: 700;
      letter-spacing: 1px;
      box-shadow: 0 2px 18px #191c2640;
      z-index: 40;
    }
    .header-title {
      font-size: 1.25em;
      font-weight: 900;
      letter-spacing: 1.3px;
      color: var(--accent);
      margin-right: 1em;
    }
    .music-btn {
      background: #292c3c;
      color: #ffd574;
      border: none;
      border-radius: 8px;
      padding: 0.4em 1em;
      cursor: pointer;
      font-weight: 600;
      font-size: 1em;
      margin-left: 1em;
      transition: background 0.13s, color 0.13s;
    }
    .music-btn:hover { background: #ffd574; color: #191c26; }
    .main-layout {
      flex: 1;
      height: calc(100vh - var(--header-height));
      display: flex;
      width: 100vw;
      overflow: hidden;
      background: var(--bg);
    }
    .sidebar {
      width: var(--sidebar-width);
      min-width: var(--sidebar-width);
      background: var(--panel);
      color: var(--txt);
      display: flex;
      flex-direction: column;
      padding: 2em 1em 1em 1em;
      box-shadow: 2px 0 16px #191c2610;
      z-index: 30;
      gap: 1.3em;
    }
    .sidebar .section-title {
      color: var(--accent2);
      font-size: 1.07em;
      font-weight: 700;
      margin-bottom: 0.5em;
      letter-spacing: 0.7px;
    }
    .stats-row {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.7em;
      margin-bottom: 0.7em;
    }
    .stat-card {
      background: var(--card);
      border-radius: 8px;
      padding: 0.55em 0.7em;
      text-align: center;
      box-shadow: 0 2px 8px #292c3c15;
    }
    .stat-label {
      color: #aaa;
      font-size: 0.85em;
      letter-spacing: 0.1px;
    }
    .stat-value {
      font-weight: 800;
      font-size: 1.12em;
      color: var(--txt);
      margin-top: 0.13em;
    }
    .bar {
      height: 7px;
      border-radius: 4px;
      margin-top: 0.17em;
      margin-bottom: -0.13em;
      background: #222;
      width: 100%;
      overflow: hidden;
      position: relative;
    }
    .health-bar { background: var(--health); }
    .energy-bar { background: var(--energy); }
    .xp-bar { background: var(--xp); }
    .sidebar .inventory-section {
      margin-top: 1.2em;
    }
    .inventory-list {
      list-style: none;
      margin: 0;
      padding: 0;
      font-size: 0.97em;
    }
    .inventory-list li {
      margin-bottom: 0.18em;
      display: flex;
      align-items: center;
      gap: 0.5em;
    }
    .inv-btn {
      background: #292c3c;
      color: #ffd574;
      border: none;
      border-radius: 5px;
      padding: 0.1em 0.7em;
      font-size: 0.85em;
      font-weight: 600;
      cursor: pointer;
      margin-left: 0.2em;
      margin-right: 0.2em;
      transition: background 0.16s, color 0.16s;
    }
    .inv-btn.active, .inv-btn:active {
      background: #ffd574;
      color: #191c26;
    }
    .sidebar .misc-info {
      color: #aaa;
      font-size: 0.91em;
      margin-top: 0.7em;
      margin-bottom: 0.5em;
    }
    .sidebar .future-panel {
      background: #191c26;
      border-radius: 8px;
      color: #ffd574;
      font-size: 0.97em;
      padding: 0.8em 0.8em;
      margin-top: 1.5em;
      text-align: center;
      opacity: 0.7;
    }
    .game-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: stretch;
      align-items: stretch;
      height: 100%;
      min-width: 0;
      overflow: hidden;
      padding: 0 2.5vw 0 2vw;
      position: relative;
    }
    .game-log {
      flex: 1;
      min-height: 60px;
      max-height: 26vh;
      overflow-y: auto;
      background: #191c26;
      border-radius: 8px;
      padding: 0.8em 0.7em;
      color: #ffb47e;
      font-size: 1.01em;
      box-shadow: 0 1px 8px #292c3c10;
      margin-bottom: 1.2em;
      margin-top: 0.6em;
      word-break: break-word;
    }
    .game-content {
      flex: 2;
      display: flex;
      flex-direction: column;
      gap: 1.1em;
      min-height: 0;
    }
    .zone, .enemy-card, .survivor-card, .future-card {
      background: var(--card);
      border-radius: 11px;
      padding: 1.2em 1em;
      box-shadow: 0 2px 12px #191c2615;
      margin-bottom: 0.6em;
      margin-top: 0.7em;
      font-size: 1.07em;
      position: relative;
    }
    .zone-title {
      font-size: 1.13em;
      font-weight: 700;
      color: var(--accent2);
      margin-bottom: 0.3em;
    }
    .zone-desc {
      color: #ccc;
      font-size: 1em;
      margin-bottom: 0.7em;
    }
    .enemy-card {
      background: #e74c3c28;
      color: #f38020;
      font-weight: 700;
      box-shadow: 0 1px 8px #e74c3c25;
    }
    .enemy-hp-bar {
      background: var(--health);
      height: 8px;
      border-radius: 4px;
      margin-top: 0.3em;
      width: 100%;
    }
    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.7em;
      margin-top: 1em;
      margin-bottom: 1em;
    }
    .action-btn {
      background: linear-gradient(90deg, var(--accent) 80%, var(--accent2) 100%);
      color: var(--txt);
      border: none;
      border-radius: 7px;
      padding: 0.8em 1.3em;
      font-size: 1.08em;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.16s, color 0.16s;
      box-shadow: 0 2px 8px #f3802011;
    }
    .action-btn:active {
      background: linear-gradient(90deg, #ffb47e 60%, #f38020 95%);
      color: #191c26;
    }
    .survivor-card, .future-card {
      background: #2980b950;
      color: #ffd574;
      font-weight: 700;
      box-shadow: 0 1px 8px #2980b933;
      font-size: 1.07em;
      text-align: left;
      position: relative;
      z-index: 97;
    }
    .survivor-card .dialogue-option, .future-card .dialogue-option {
      background: #ffd574;
      color: #191c26;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      font-size: 1em;
      margin: 0.5em 0.2em 0.5em 0;
      padding: 0.6em 1em;
      cursor: pointer;
      transition: background 0.16s, color 0.16s;
      box-shadow: 0 2px 8px #ffd57422;
      display: block;
      width: 100%;
      text-align: left;
    }
    .dialogue-option:hover {
      background: #f38020;
      color: #fff;
    }
    .level-up {
      background: #27ae60;
      color: #fff;
      border-radius: 8px;
      padding: 0.7em 1.1em;
      text-align: center;
      font-size: 1.18em;
      margin-top: 1em;
      font-weight: 700;
      box-shadow: 0 2px 16px #27ae6044;
      margin-bottom: 1em;
    }
    .game-over {
      background: #e74c3c;
      color: #fff;
      border-radius: 10px;
      padding: 1em 1.2em;
      text-align: center;
      font-size: 1.5em;
      margin-top: 2em;
      font-weight: 800;
      box-shadow: 0 2px 16px #e74c3c44;
      position: absolute;
      left: 50%; top: 35%;
      transform: translate(-50%, -35%);
      z-index: 100;
      min-width: 300px;
    }
    .restart-btn {
      margin-top: 1.2em;
      background: linear-gradient(90deg, #27ae60 80%, #f38020 100%);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 0.7em 1.4em;
      font-size: 1.09em;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 2px 12px #27ae6011;
      transition: background 0.16s, color 0.16s;
    }
    .restart-btn:active { background: #f38020; color: #fff;}
    .modal-bg {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: var(--modalbg);
      z-index: 99;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: #292c3c;
      border-radius: 13px;
      padding: 2em 1.5em;
      box-shadow: 0 6px 38px #191c2640;
      color: var(--txt);
      min-width: 220px;
      max-width: 340px;
      text-align: center;
      position: relative;
    }
    .modal-content h3 {
      color: var(--accent);
      font-size: 1.2em;
      margin-top: 0;
      margin-bottom: 0.7em;
    }
    .modal-content .close-btn {
      position: absolute;
      top: 0.8em; right: 0.8em;
      background: #22243a;
      color: #ffd574;
      border: none;
      border-radius: 7px;
      font-size: 1.15em;
      font-weight: 700;
      cursor: pointer;
      padding: 0.1em 0.55em;
      transition: background 0.15s, color 0.15s;
    }
    .modal-content .close-btn:hover { background: #ffd574; color: #22243a;}
    @media (max-width: 900px) {
      .main-layout { flex-direction: column; }
      .sidebar { width:auto; min-width:unset; flex-direction:row; gap:2vw; padding:1.1em 2vw; }
      .game-area { padding: 0 2vw 0 2vw; }
    }
    @media (max-width: 650px) {
      .sidebar { flex-direction:column; gap: 0.6em; padding:0.7em 1vw; }
      .header { padding: 0 0.8em 0 0.6em; font-size: 1em;}
      .game-area { padding:0 0.3em; }
      .game-over { min-width: 90vw;}
    }
  </style>
</head>
<body>
  <audio id="bg-music" src="/Pixel_Video_Game_-_NTRSLNC.mp3" loop></audio>
  <div class="header">
    <span class="header-title">Zombie Survival RPG</span>
    <button class="music-btn" id="toggleMusicBtn">🔊 Music</button>
  </div>
  <div class="main-layout">
    <aside class="sidebar">
      <div>
        <div class="section-title">Stats</div>
        <div id="stats"></div>
      </div>
      <div class="inventory-section">
        <div class="section-title">Inventory</div>
        <ul class="inventory-list" id="inventory"></ul>
        <div class="misc-info" id="misc-info"></div>
      </div>
      <div class="future-panel">
        <div>Future features:</div>
        <div>• Upgrades</div>
        <div>• Quest Log</div>
        <div>• Map</div>
        <div>• Allies</div>
      </div>
    </aside>
    <section class="game-area">
      <div class="game-content">
        <div id="zone"></div>
        <div id="enemy"></div>
        <div id="survivor"></div>
        <div id="poi"></div>
        <div id="levelup"></div>
        <div class="actions" id="actions"></div>
      </div>
      <div class="game-log" id="log"></div>
      <div id="gameover"></div>
      <div id="modal" style="display:none;"></div>
    </section>
  </div>
  <script>
    // Music controls
    window.addEventListener('DOMContentLoaded', () => {
      const audio = document.getElementById('bg-music');
      function tryPlay() {
        audio.volume = 0.2;
        audio.play().catch(()=>{});
        window.removeEventListener('click', tryPlay);
        window.removeEventListener('keydown', tryPlay);
      }
      window.addEventListener('click', tryPlay);
      window.addEventListener('keydown', tryPlay);
    });
    document.getElementById('toggleMusicBtn').onclick = function() {
      const audio = document.getElementById('bg-music');
      if (audio.muted) {
        audio.muted = false;
        this.textContent = "🔊 Music";
      } else {
        audio.muted = true;
        this.textContent = "🔇 Music";
      }
    };

    // --- Game Data ---
    const playerBase = {
      name: "Survivor",
      health: 100,
      maxHealth: 100,
      energy: 50,
      maxEnergy: 50,
      xp: 0,
      level: 1,
      xpNext: 100,
      attack: 15,
      defense: 8,
      crit: 0.1,
      inventory: ["Knife", "Medkit"],
      weapon: "Knife",
      medkits: 1,
      food: 0,
      zone: 0,
      alive: true,
      zombiesKilled: 0,
      turns: 0,
      zoneLoots: [0,0,0,0,0]
    };
    const zoneLootReq = [10, 11, 12, 13, 35, 5];

    const zones = [
      {
        name: "Downtown Ruins",
        desc: "Skyscrapers and streets littered with debris. Zombies roam everywhere.",
        encounterChance: 0.7,
        lootChance: 0.4,
        lootTable: ["Medkit", "Food", "Pistol", "Bandage", "Energy Drink"],
        enemies: [
          {type: "Zombie", hp: 20, atk: 7, def: 2, xp: 25, desc: "Shambling corpse"},
          {type: "Fast Zombie", hp: 18, atk: 11, def: 2, xp: 35, desc: "Quick and aggressive"},
          {type: "Infected Dog", hp: 14, atk: 9, def: 1, xp: 20, desc: "Rabid and fast"},
        ]
      },
      {
        name: "Abandoned Hospital",
        desc: "Dark corridors and operating rooms. Watch out for lurking threats.",
        encounterChance: 0.8,
        lootChance: 0.5,
        lootTable: ["Medkit", "Bandage", "Shotgun", "Food", "Painkillers"],
        enemies: [
          {type: "Zombie Nurse", hp: 23, atk: 10, def: 2, xp: 30, desc: "Still in scrubs"},
          {type: "Crawler", hp: 15, atk: 8, def: 1, xp: 20, desc: "Moves low and fast"},
          {type: "Bloater", hp: 30, atk: 18, def: 6, xp: 50, desc: "Huge, explodes on death"},
        ]
      },
      {
        name: "Suburban Streets",
        desc: "Once-safe homes now overrun. Good loot, but more dangerous zombies.",
        encounterChance: 0.7,
        lootChance: 0.55,
        lootTable: ["Food", "Energy Drink", "Rifle", "Medkit", "Bandage"],
        enemies: [
          {type: "Zombie", hp: 22, atk: 8, def: 2, xp: 25, desc: "Restless infected"},
          {type: "Runner", hp: 19, atk: 13, def: 3, xp: 40, desc: "Sprints at you"},
          {type: "Zombie Brute", hp: 36, atk: 20, def: 8, xp: 60, desc: "Massive and tough"},
        ]
      },
      {
        name: "Military Checkpoint",
        desc: "Barricaded, but overrun. High risk, high reward.",
        encounterChance: 0.5,
        lootChance: 0.7,
        lootTable: ["Ammo", "Grenade", "Rifle", "Medkit", "Energy Drink"],
        enemies: [
          {type: "Zombie Soldier", hp: 24, atk: 15, def: 4, xp: 45, desc: "Armed and armored"},
          {type: "Military Dog", hp: 18, atk: 14, def: 2, xp: 25, desc: "Trained, now infected"},
          {type: "Zombie Captain", hp: 38, atk: 23, def: 11, xp: 70, desc: "Old military captain turned infected"},
        ]
      },
       {
        name: "Zombie Infested Wasteland ",
        desc: "Best get out quick, the zombies here are dangerous.",
        encounterChance: 0.8,
        lootChance: 0.2,
        lootTable: ["Medkit", "Bandage", "Shotgun", "Food", "Painkillers"],
        enemies: [
          {type: "???", hp: 94, atk: 30, def: 2, xp: 235, desc: "You feel your head being filled with amnesia"},
          {type: "Dreadful Zombie", hp: 3, atk: 102, def: 1, xp: 9, desc: "It looks like it's falling apart"},
          {type: "Test", hp: 67, atk: 102, def: 1, xp: 99999999, desc: "It charges like a brute and a runner combined"},
        ]
      },
      {
        name: "Safe House",
        desc: "A rare place to rest and heal. No enemies, but limited loot.",
        encounterChance: 0.0,
        lootChance: 0.4,
        lootTable: ["Medkit", "Food", "Bandage", "Energy Drink"],
        enemies: []
      }
    ];

    const weapons = {
      "Knife": {atk: 15, crit: 0.10, desc: "Basic melee weapon. Fast, but low damage."},
      "Pistol": {atk: 22, crit: 0.17, desc: "Reliable ranged weapon. Moderate damage and crit."},
      "Shotgun": {atk: 32, crit: 0.24, desc: "Powerful short-range weapon. High damage, high crit."},
      "Rifle": {atk: 40, crit: 0.30, desc: "Long-range, high-damage weapon. High crit chance."},
      "Grenade": {atk: 65, crit: 0.0, desc: "Explosive weapon. Single-use. Massive damage, no crit."},
      "hhiiii squiddwarrdddd": {atk: 999, crit: 0.0, desc: "Squidward dies"}
    };

    const foodItems = {
      "Food": {energy: 18, heal: 0},
      "Energy Drink": {energy: 35, heal: 0}
    };

    const survivors = [
      {
        name: "Sarah the Medic",
        desc: "A cautious medic searching for supplies.",
        dialogues: [
          {
            text: "She nervously greets you. 'Who are you? What do you want?'",
            options: [
              {choice: "I'm friendly. Need help?", outcome: "heal", response: "Sarah smiles and gives you a medkit.", effect: {medkits: +1}},
              {choice: "Hand over your supplies.", outcome: "attack", response: "Sarah fights back and flees. You take damage.", effect: {damage: 15}},
              {choice: "Let's team up.", outcome: "ally", response: "Sarah joins you for a few turns and heals you.", effect: {heal: 20}},
            ]
          }
        ]
      },
      {
        name: "Mike the Scavenger",
        desc: "A tough scavenger, armed and wary.",
        dialogues: [
          {
            text: "He raises his weapon. 'Stay back! Are you infected?'",
            options: [
              {choice: "No, just passing through.", outcome: "trade", response: "Mike trades you a random item.", effect: "trade"},
              {choice: "Lower your weapon.", outcome: "attack", response: "Mike shoots at you and escapes.", effect: {damage: 20}},
              {choice: "Want to share supplies?", outcome: "share", response: "Mike shares some food.", effect: {food: +1}},
            ]
          }
        ]
      },
      {
        name: "Emma the Survivor",
        desc: "She looks scared and desperate.",
        dialogues: [
          {
            text: "She pleads, 'Do you have any food? Please?'",
            options: [
              {choice: "Give food.", outcome: "give", response: "Emma thanks you and gives you a medkit.", effect: {medkits: +1, food: -1}},
              {choice: "Ignore her.", outcome: "sad", response: "Emma runs away, nothing happens.", effect: {}},
              {choice: "Threaten her.", outcome: "attack", response: "Emma panics and throws a rock at you. You lose health.", effect: {damage: 10}},
            ]
          }
        ]
      }
    ];

    const pois = [
      {
        title: "Zombies Feast",
        desc: "You stop and see several zombies feasting on a corpse.",
        options: [
          {choice: "Sneak by quietly", outcome: "sneak", response: "You sneak by, but your heart races.", effect: {energy: -4, loot: 1, danger: 0.2}},
          {choice: "Attack the zombies", outcome: "attack", response: "You attack! The zombies turn on you.", effect: {enemy: true}},
          {choice: "Search the corpse for supplies", outcome: "loot", response: "You quickly search and grab something.", effect: {loot: 1, danger: 0.4}},
          {choice: "Ignore and move on", outcome: "ignore", response: "You decide not to risk it.", effect: {}}
        ]
      },
      {
        title: "Barricaded Shop",
        desc: "A small shop is barricaded. You hear noises inside.",
        options: [
          {choice: "Knock and call out", outcome: "survivor", response: "Someone answers from within!", effect: {survivor: true}},
          {choice: "Break down the door", outcome: "breakin", response: "You break in and trigger an alarm!", effect: {loot: 2, danger: 0.5}},
          {choice: "Leave it alone", outcome: "leave", response: "Best not to draw attention.", effect: {}}
        ]
      },
      {
        title: "Crashed Ambulance",
        desc: "You spot a crashed ambulance, doors ajar.",
        options: [
          {choice: "Search for medical supplies", outcome: "medloot", response: "You find a medkit!", effect: {medkits: 1, loot: 1, danger: 0.3}},
          {choice: "Check for survivors", outcome: "medsurvivor", response: "A wounded survivor is inside.", effect: {survivor: true}},
          {choice: "Leave quickly", outcome: "leave", response: "You don't risk it.", effect: {}}
        ]
      },
      {
        title: "Trap in Alley",
        desc: "Tripwire and cans rattle. Someone set a trap here.",
        options: [
          {choice: "Carefully disable the trap", outcome: "disable", response: "You disable it and find some loot.", effect: {loot: 1}},
          {choice: "Ignore and walk away", outcome: "ignore", response: "You avoid the trap.", effect: {}},
          {choice: "Rush through", outcome: "rush", response: "You set off the trap! Ouch.", effect: {damage: 12}}
        ]
      },
      {
        title: "Supply Drop",
        desc: "A parachute flutters nearby. Someone dropped supplies recently.",
        options: [
          {choice: "Search the crate", outcome: "search", response: "You find rare supplies!", effect: {loot: 2}},
          {choice: "Ambush anyone approaching", outcome: "ambush", response: "You wait, but only zombies show up.", effect: {enemy: true}},
          {choice: "Ignore", outcome: "ignore", response: "You move on.", effect: {}}
        ]
      }
    ];

    let player = {};
    let enemy = null;
    let log = [];
    let levelUpMsg = "";
    let gameOverMsg = "";
    let survivor = null;
    let survivorDialogueStep = 0;
    let poi = null;

    function roll(prob) { return Math.random() < prob; }
    function randint(min, max) { return Math.floor(Math.random() * (max-min+1))+min; }
    function cap(val, max) { return Math.min(val, max); }

    function updateStats() {
      document.getElementById("stats").innerHTML = `
        <div class="stats-row">
          <div class="stat-card">
            <div class="stat-label">Health</div>
            <div class="stat-value">${player.health}/${player.maxHealth}</div>
            <div class="bar"><div class="health-bar" style="width:${(player.health/player.maxHealth)*100}%"></div></div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Energy</div>
            <div class="stat-value">${player.energy}/${player.maxEnergy}</div>
            <div class="bar"><div class="energy-bar" style="width:${(player.energy/player.maxEnergy)*100}%"></div></div>
          </div>
          <div class="stat-card">
            <div class="stat-label">XP</div>
            <div class="stat-value">${player.xp}/${player.xpNext}</div>
            <div class="bar"><div class="xp-bar" style="width:${(player.xp/player.xpNext)*100}%"></div></div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Level</div>
            <div class="stat-value">${player.level}</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Weapon</div>
          <div class="stat-value">${player.weapon}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Zone</div>
          <div class="stat-value">${zones[player.zone].name}</div>
        </div>
      `;
    }

    function updateInventory() {
      let items = {};
      player.inventory.forEach(i => items[i] = (items[i]||0)+1);
      let invList = Object.entries(items).map(([name, cnt]) => {
        let isWeapon = weapons[name];
        let equipBtn = isWeapon
          ? `<button class="inv-btn${player.weapon===name?' active':''}" onclick="equipItem('${name}')">${player.weapon===name?'Equipped':'Equip'}</button>
             <button class="inv-btn" onclick="showWeaponInfo('${name}')">Info</button>`
          : '';
        return `<li>${name} <span style="color:#ffd574;">x${cnt}</span> ${equipBtn}</li>`;
      }).join("");
      document.getElementById("inventory").innerHTML = invList || "<li>(empty)</li>";
      document.getElementById("misc-info").innerHTML =
        `Medkits: ${player.medkits} | Food: ${player.food} | Zombies killed: ${player.zombiesKilled}`;
    }

    function updateZone() {
      const zone = zones[player.zone];
      document.getElementById("zone").innerHTML = `
        <div class="zone">
          <div class="zone-title">${zone.name}</div>
          <div class="zone-desc">${zone.desc}</div>
          <div><b>Loot chance:</b> ${Math.round(zone.lootChance*100)}%</div>
          <div><b>Encounter chance:</b> ${Math.round(zone.encounterChance*100)}%</div>
        </div>
      `;
    }

    function updateEnemy() {
      if (!enemy) { document.getElementById("enemy").innerHTML = ""; return; }
      document.getElementById("enemy").innerHTML = `
        <div class="enemy-card">
          <div>${enemy.type} (${enemy.desc})</div>
          <div>HP: ${enemy.hp}/${enemy.maxHp}</div>
          <div class="bar"><div class="enemy-hp-bar" style="width:${(enemy.hp/enemy.maxHp)*100}%"></div></div>
          <div>Attack: ${enemy.atk} | Defense: ${enemy.def}</div>
        </div>
      `;
    }

    function updateLog() {
      document.getElementById("log").innerHTML = log.slice(-12).map(msg => `<div>${msg}</div>`).join("");
    }

    function updateLevelUp() {
      document.getElementById("levelup").innerHTML = levelUpMsg;
    }

    function updateGameOver() {
      document.getElementById("gameover").innerHTML = gameOverMsg;
    }

    function updateActions() {
      const actions = document.getElementById("actions");
      actions.innerHTML = "";
      if (gameOverMsg || survivor || poi) return;
      if (enemy) {
        actions.innerHTML += `<button class="action-btn" onclick="playerAttack()">Attack</button>`;
        actions.innerHTML += `<button class="action-btn" onclick="playerHeal()">Heal (${player.medkits} medkit${player.medkits!==1?'s':''})</button>`;
        actions.innerHTML += `<button class="action-btn" onclick="playerRun()">Run</button>`;
        actions.innerHTML += `<button class="action-btn" onclick="playerDodge()">Dodge</button>`;
      } else {
        actions.innerHTML += `<button class="action-btn" onclick="searchLoot()">Search for loot</button>`;
        actions.innerHTML += `<button class="action-btn" onclick="rest()">Rest</button>`;
        actions.innerHTML += `<button class="action-btn" onclick="moveZone()">Move to next zone</button>`;
        actions.innerHTML += `<button class="action-btn" onclick="eatFood()">Eat food (${player.food})</button>`;
        actions.innerHTML += `<div style="color:#ffd574;font-size:1.09em;margin-top:0.3em;">Loots needed in this zone: <b>${zoneLootReq[player.zone] - player.zoneLoots[player.zone]}</b></div>`;
      }
    }

    function updateSurvivor() {
      const survivorDiv = document.getElementById("survivor");
      if (!survivor) { survivorDiv.innerHTML = ""; return; }
      const dialogueObj = survivor.dialogues[survivorDialogueStep];
      survivorDiv.innerHTML = `
        <div class="survivor-card">
          <div style="font-size:1.15em;color:#ffd574;">${survivor.name}</div>
          <div style="color:#fff;margin-bottom:0.7em;">${survivor.desc}</div>
          <div class="survivor-dialogue">${dialogueObj.text}</div>
          ${dialogueObj.options.map((opt, idx) =>
            `<button class="dialogue-option" onclick="chooseDialogue(${idx})">${opt.choice}</button>`
          ).join("")}
        </div>
      `;
    }

    function updatePOI() {
      const poiDiv = document.getElementById("poi");
      if (!poi) { poiDiv.innerHTML = ""; return; }
      poiDiv.innerHTML = `
        <div class="future-card">
          <div style="font-size:1.15em;color:#ffd574;">${poi.title}</div>
          <div style="color:#fff;margin-bottom:0.7em;">${poi.desc}</div>
          ${poi.options.map((opt, idx) =>
            `<button class="dialogue-option" onclick="choosePOI(${idx})">${opt.choice}</button>`
          ).join("")}
        </div>
      `;
    }

    window.choosePOI = function(idx) {
      const opt = poi.options[idx];
      log.push(`<span style="color:#ffd574;">Event:</span> ${opt.response}`);
      if (opt.effect.energy) player.energy = Math.max(0, player.energy + opt.effect.energy);
      if (opt.effect.loot) gainLoot(opt.effect.loot);
      if (opt.effect.enemy) {
        const zone = zones[player.zone];
        const eData = zone.enemies[randint(0,zone.enemies.length-1)];
        enemy = {...eData, hp: eData.hp, maxHp: eData.hp};
        log.push(`A wild ${enemy.type} appears!`);
      }
      if (opt.effect.survivor) {
        triggerSurvivorEncounter();
        poi = null;
        updatePOI();
        updateAll();
        return;
      }
      if (opt.effect.medkits) player.medkits += opt.effect.medkits;
      if (opt.effect.damage) {
        player.health -= opt.effect.damage;
        log.push("You take damage!");
        if (player.health <= 0) { player.health=0; player.alive=false; endGame(); }
      }
      if (opt.effect.danger && roll(opt.effect.danger)) {
        const zone = zones[player.zone];
        const eData = zone.enemies[randint(0,zone.enemies.length-1)];
        enemy = {...eData, hp: eData.hp, maxHp: eData.hp};
        log.push(`Danger! A ${enemy.type} attacks!`);
      }
      poi = null;
      updatePOI();
      updateAll();
    };

    function gainLoot(n=1) {
      for (let i=0;i<n;i++) {
        player.zoneLoots[player.zone]++;
        const zone = zones[player.zone];
        let loot = zone.lootTable[randint(0,zone.lootTable.length-1)];
        log.push(`You found <span style="color:#ffd574;">${loot}</span>!`);
        if (loot === "Medkit") player.medkits++;
        else if (loot === "Food") player.food++;
        else player.inventory.push(loot);
      }
    }

    window.searchLoot = function() {
      const zone = zones[player.zone];
      player.turns++;
      if (roll(0.12 + player.level*0.01)) {
        triggerSurvivorEncounter();
        updateAll();
        return;
      }
      if (roll(0.18 + player.level*0.015)) {
        poi = pois[randint(0, pois.length-1)];
        updatePOI();
        updateActions();
        return;
      }
      if (roll(zone.lootChance)) {
        gainLoot(1);
      } else {
        log.push("No loot found.");
      }
      if (roll(zone.encounterChance)) {
        const eData = zone.enemies[randint(0,zone.enemies.length-1)];
        enemy = {...eData, hp: eData.hp, maxHp: eData.hp};
        log.push(`A wild ${enemy.type} appears!`);
      }
      updateAll();
    };

    window.moveZone = function() {
      if (player.zoneLoots[player.zone] < zoneLootReq[player.zone]) {
        log.push(`You need to loot ${zoneLootReq[player.zone] - player.zoneLoots[player.zone]} more times before moving to the next zone.`);
        updateAll();
        return;
      }
      if (player.zone < zones.length-1) {
        player.zone++;
        log.push(`You move to: <span style="color:#ffd574;">${zones[player.zone].name}</span>`);
        player.energy = Math.max(5, player.energy-10);
        player.zoneLoots[player.zone] = player.zoneLoots[player.zone] || 0;
        const zone = zones[player.zone];
        if (roll(zone.encounterChance-0.15)) {
          const eData = zone.enemies[randint(0,zone.enemies.length-1)];
          enemy = {...eData, hp: eData.hp, maxHp: eData.hp};
          log.push(`A ${enemy.type} ambushes you!`);
        }
        updateAll();
      } else {
        log.push("You are at the last zone (Safe House). Rest and heal, you beat the game until we add more stages!");
        updateAll();
      }
    };

    window.rest = function() {
      player.turns++;
      let restHeal = randint(12,21) + player.level*2;
      let restEnergy = randint(8,18) + player.level;
      player.health = cap(player.health+restHeal, player.maxHealth);
      player.energy = cap(player.energy+restEnergy, player.maxEnergy);
      log.push(`You rest and recover ${restHeal} HP and ${restEnergy} energy.`);
      const zone = zones[player.zone];
      if (roll(zone.encounterChance-0.25)) {
        const eData = zone.enemies[randint(0,zone.enemies.length-1)];
        enemy = {...eData, hp: eData.hp, maxHp: eData.hp};
        log.push(`A ${enemy.type} attacks during your rest!`);
      }
      updateAll();
    };

    window.eatFood = function() {
      if (player.food > 0) {
        player.food--;
        let energy = foodItems["Food"].energy + randint(-3,3);
        player.energy = cap(player.energy+energy, player.maxEnergy);
        log.push(`You eat some food and gain ${energy} energy.`);
      } else {
        log.push("No food to eat.");
      }
      updateAll();
    };

    window.playerAttack = function() {
      if (!player.alive || !enemy) return;
      const weaponStats = weapons[player.weapon] || weapons["Knife"];
      let dmg = weaponStats.atk + randint(-5,5) + player.level*2;
      if (roll(weaponStats.crit)) { dmg = Math.round(dmg*1.7); log.push("Critical hit!"); }
      dmg = Math.max(1, dmg - enemy.def);
      enemy.hp -= dmg;
      log.push(`You hit the ${enemy.type} for ${dmg} damage.`);
      if (enemy.hp <= 0) {
        log.push(`You defeated the ${enemy.type}!`);
        player.xp += enemy.xp;
        player.zombiesKilled++;
        enemy = null;
        checkLevelUp();
      } else {
        enemyAttack();
      }
      updateAll();
    };

    function enemyAttack() {
      if (!player.alive || !enemy) return;
      let dmg = enemy.atk + randint(-3,3);
      dmg = Math.max(1, dmg - player.defense);
      player.health -= dmg;
      log.push(`The ${enemy.type} hits you for ${dmg} damage.`);
      if (player.health <= 0) {
        player.health = 0;
        player.alive = false;
        log.push(`You have died...`);
        endGame();
      }
    }

    window.playerHeal = function() {
      if (player.medkits > 0 && player.health < player.maxHealth) {
        player.medkits--;
        let heal = 30 + randint(-5,5) + player.level*2;
        player.health = Math.min(player.maxHealth, player.health+heal);
        log.push(`You use a medkit and heal ${heal} HP.`);
        if (enemy) enemyAttack();
      } else {
        log.push("No medkits to use or already at full health.");
        if (enemy) enemyAttack();
      }
      updateAll();
    };

    window.playerRun = function() {
      if (!enemy) return;
      if (roll(0.45 + player.level*0.03)) {
        log.push("You escaped the fight!");
        enemy = null;
      } else {
        log.push("Failed to escape!");
        enemyAttack();
      }
      updateAll();
    };

    window.playerDodge = function() {
      if (!enemy) return;
      let dodgeChance = 0.40 + (player.energy/player.maxEnergy)*0.25 + (weapons[player.weapon]?.crit||0)*0.2 + player.level*0.01;
      if (roll(dodgeChance)) {
        log.push("You dodge the enemy's attack and avoid all damage!");
      } else {
        log.push("Dodge failed.");
        enemyAttack();
      }
      player.energy = Math.max(0, player.energy-8);
      updateAll();
    };

    function checkLevelUp() {
      if (player.xp >= player.xpNext) {
        player.level++;
        player.xp = player.xp-player.xpNext;
        player.xpNext = Math.round(player.xpNext*1.3+50);
        player.maxHealth = Math.round(player.maxHealth*1.12+6);
        player.maxEnergy = Math.round(player.maxEnergy*1.1+3);
        player.attack = Math.round(player.attack*1.09+2);
        player.defense = Math.round(player.defense*1.09+2);
        levelUpMsg = `<div class="level-up">Level up! You are now level ${player.level}!</div>`;
        setTimeout(()=>{levelUpMsg="";updateLevelUp();}, 1200);
      }
    }

    function endGame() {
      gameOverMsg = `<div class="game-over">Game Over<br>You survived ${player.turns} turns and killed ${player.zombiesKilled} zombies.<br>
      <button class="restart-btn" onclick="restartGame()">Restart</button></div>`;
      updateGameOver();
    }

    window.restartGame = function() {
      startGame();
    };

    window.equipItem = function(name) {
      if (!weapons[name]) return;
      player.weapon = name;
      log.push(`You equipped <span style="color:#ffd574;">${name}</span>.`);
      updateAll();
    };

    window.showWeaponInfo = function(name) {
      const stats = weapons[name];
      if (!stats) return;
      showModal(`
        <h3>${name} Info</h3>
        <div style="font-size:1.05em;margin:0.7em 0;">${stats.desc}</div>
        <div style="color:#ffd574;font-size:1.09em;font-weight:700;">Attack: ${stats.atk}<br>Crit Chance: ${Math.round(stats.crit*100)}%</div>
        <button class="close-btn" onclick="closeModal()">✕</button>
      `);
    };

    function showModal(content) {
      const modal = document.getElementById('modal');
      modal.innerHTML = `<div class="modal-bg" onclick="closeModal()"><div class="modal-content" onclick="event.stopPropagation();">${content}</div></div>`;
      modal.style.display = '';
    }
    window.closeModal = function() {
      document.getElementById('modal').innerHTML = '';
      document.getElementById('modal').style.display = 'none';
    };

    function triggerSurvivorEncounter() {
      survivorDialogueStep = 0;
      survivor = survivors[randint(0, survivors.length-1)];
      updateSurvivor();
      updateActions();
    }

    window.chooseDialogue = function(idx) {
      const dialogueObj = survivor.dialogues[survivorDialogueStep];
      const opt = dialogueObj.options[idx];
      log.push(`<span style="color:#ffd574;">${survivor.name}</span>: ${opt.response}`);
      if (opt.effect) {
        if (opt.effect.heal) player.health = cap(player.health+opt.effect.heal, player.maxHealth);
        if (opt.effect.medkits) player.medkits += opt.effect.medkits;
        if (opt.effect.food) player.food += opt.effect.food;
        if (opt.effect.damage) {
          player.health -= opt.effect.damage;
          if (player.health <= 0) { player.health=0; player.alive=false; endGame(); }
        }
      }
      if (opt.effect === "trade") {
        const lootTable = zones[player.zone].lootTable;
        let loot = lootTable[randint(0,lootTable.length-1)];
        log.push(`${survivor.name} trades you <span style="color:#ffd574;">${loot}</span>.`);
        if (loot === "Medkit") player.medkits++;
        else if (loot === "Food") player.food++;
        else player.inventory.push(loot);
      }
      survivor = null;
      updateSurvivor();
      updateAll();
    };

    function updateAll() {
      updateStats();
      updateZone();
      updateInventory();
      updateEnemy();
      updateSurvivor();
      updatePOI();
      updateActions();
      updateLog();
      updateLevelUp();
      updateGameOver();
    }

    function startGame() {
      player = JSON.parse(JSON.stringify(playerBase));
      enemy = null;
      log = ["You awaken in a destroyed city, desperate to survive..."];
      levelUpMsg = "";
      gameOverMsg = "";
      survivor = null;
      poi = null;
      updateAll();
    }

    startGame();

    window.playerAttack = playerAttack;
    window.playerHeal = playerHeal;
    window.playerRun = playerRun;
    window.playerDodge = playerDodge;
    window.searchLoot = searchLoot;
    window.rest = rest;
    window.moveZone = moveZone;
    window.eatFood = eatFood;
    window.equipItem = equipItem;
    window.showWeaponInfo = showWeaponInfo;
    window.closeModal = closeModal;
    window.chooseDialogue = chooseDialogue;
    window.restartGame = restartGame;
    window.choosePOI = choosePOI;
  </script>
</body>
</html>
